name: PR Build

on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  REGISTRY: quay.io
  REGISTRY_IMAGE: rhdh-community/dynamic-plugins-factory

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Check if build should be skipped
        id: skip_check
        uses: ./.github/actions/should-skip-build
        with:
          commit-sha: ${{ github.sha }}
          check-image: 'false'
          file-patterns: |
            \.md$
            ^renovate\.json$
            ^examples\/
            ^\.cursor\/
            ^tests\/

      - name: Build container and export artifact
        if: steps.skip_check.outputs.should_skip != 'true'
        id: build
        uses: ./.github/actions/build-container
        with:
          push: 'false'
          registry: ${{ env.REGISTRY }}
          image: ${{ env.REGISTRY_IMAGE }}
          pr-number: ${{ github.event.number }}
          commit-sha: ${{ github.sha }}

      - name: Save PR metadata
        if: steps.skip_check.outputs.should_skip != 'true'
        env:
          PR_NUMBER: ${{ github.event.number }}
          COMMIT_SHA: ${{ github.sha }}
          SHORT_SHA: ${{ steps.build.outputs.short-sha }}
          PRIMARY_TAG: ${{ steps.build.outputs.primary-tag }}
          ALL_TAGS: ${{ steps.build.outputs.all-tags }}
          ARTIFACT_NAME: ${{ steps.build.outputs.artifact-name }}
        run: |
          mkdir -p /tmp/pr-metadata
          # Convert comma-separated tags to JSON array
          ALL_TAGS_JSON=$(echo "${ALL_TAGS}" | tr ',' '\n' | jq -R . | jq -s .)
          cat > /tmp/pr-metadata/pr-info.json << EOF
          {
            "pr_number": "${PR_NUMBER}",
            "commit_sha": "${COMMIT_SHA}",
            "short_sha": "${SHORT_SHA}",
            "primary_tag": "${PRIMARY_TAG}",
            "all_tags": ${ALL_TAGS_JSON},
            "artifact_name": "${ARTIFACT_NAME}"
          }
          EOF

      - name: Upload PR metadata
        if: steps.skip_check.outputs.should_skip != 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: pr-metadata
          path: /tmp/pr-metadata/pr-info.json
          retention-days: 7
          if-no-files-found: error

      - name: Build Summary
        if: steps.skip_check.outputs.should_skip != 'true'
        env:
          PRIMARY_TAG: ${{ steps.build.outputs.primary-tag }}
          ALL_TAGS: ${{ steps.build.outputs.all-tags }}
          SHORT_SHA: ${{ steps.build.outputs.short-sha }}
          PR_NUMBER: ${{ github.event.number }}
        run: |
          echo "## PR Container Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Container image built and exported as artifact for PR #${PR_NUMBER}." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tags" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`${PRIMARY_TAG}\` | Primary PR tag |" >> $GITHUB_STEP_SUMMARY
          echo "| \`pr-${PR_NUMBER}-${SHORT_SHA}\` | PR tag with commit SHA |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The [PR Publish](${{ github.server_url }}/${{ github.repository }}/actions/workflows/pr-publish.yaml) workflow will:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the built container artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Push to \`${{ env.REGISTRY }}/${{ env.REGISTRY_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Add a comment to this PR with the image details" >> $GITHUB_STEP_SUMMARY

      - name: Build Skipped Summary
        if: steps.skip_check.outputs.should_skip == 'true'
        run: |
          echo "## PR Container Build Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Reason" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.skip_check.outputs.skip_reason }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: #${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No container build was performed." >> $GITHUB_STEP_SUMMARY
