# Publish PR container images after pr-build.yaml completes
# This workflow runs in a privileged context with access to secrets.
# It downloads the container artifact built by pr-build.yaml, pushes to registry,
# and comments on the PR with image details.
name: PR Publish

on:
  workflow_run:
    workflows: ["PR Build"]
    types: [completed]

env:
  REGISTRY: quay.io
  REGISTRY_IMAGE: rhdh-community/dynamic-plugins-factory

jobs:
  publish:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: read
      pull-requests: write
      actions: read
    env:
      HAS_QUAY_AUTH: ${{ secrets.QUAY_USERNAME != '' && secrets.QUAY_TOKEN != '' }}
    steps:
      - name: Download PR metadata artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: pr-metadata
          path: /tmp/pr-metadata
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read PR metadata
        id: pr-info
        run: |
          # Read and validate PR metadata
          # SECURITY: This artifact comes from an untrusted PR workflow
          # All values must be strictly validated before use
          if [[ ! -f "/tmp/pr-metadata/pr-info.json" ]]; then
            echo "Error: PR metadata file not found"
            exit 1
          fi
          
          # Parse JSON values
          PR_NUMBER=$(jq -r '.pr_number' /tmp/pr-metadata/pr-info.json)
          COMMIT_SHA=$(jq -r '.commit_sha' /tmp/pr-metadata/pr-info.json)
          SHORT_SHA=$(jq -r '.short_sha' /tmp/pr-metadata/pr-info.json)
          PRIMARY_TAG=$(jq -r '.primary_tag' /tmp/pr-metadata/pr-info.json)
          # Convert JSON array to comma-separated string
          ALL_TAGS=$(jq -r '.all_tags | if type == "array" then join(",") else . end' /tmp/pr-metadata/pr-info.json)
          ARTIFACT_NAME=$(jq -r '.artifact_name' /tmp/pr-metadata/pr-info.json)
          
          # Validate PR number is numeric (1-7 digits)
          if ! [[ "$PR_NUMBER" =~ ^[0-9]{1,7}$ ]]; then
            echo "Error: Invalid PR number: $PR_NUMBER"
            exit 1
          fi
          
          # Validate commit SHA is 40 hex characters
          if ! [[ "$COMMIT_SHA" =~ ^[a-f0-9]{40}$ ]]; then
            echo "Error: Invalid commit SHA: $COMMIT_SHA"
            exit 1
          fi
          
          # Validate short SHA is 7 hex characters
          if ! [[ "$SHORT_SHA" =~ ^[a-f0-9]{7}$ ]]; then
            echo "Error: Invalid short SHA: $SHORT_SHA"
            exit 1
          fi
          
          # Validate primary tag format (pr-NUMBER or pr-NUMBER-SHA)
          if ! [[ "$PRIMARY_TAG" =~ ^pr-[0-9]{1,7}(-[a-f0-9]{7})?$ ]]; then
            echo "Error: Invalid primary tag: $PRIMARY_TAG"
            exit 1
          fi
          
          # Validate all_tags contains only safe characters (alphanumeric, dash, comma)
          if ! [[ "$ALL_TAGS" =~ ^[a-zA-Z0-9,.-]+$ ]]; then
            echo "Error: Invalid all_tags format: $ALL_TAGS"
            exit 1
          fi
          
          # Validate artifact name format
          if ! [[ "$ARTIFACT_NAME" =~ ^container-image-pr-[0-9]{1,7}$ ]]; then
            echo "Error: Invalid artifact name: $ARTIFACT_NAME"
            exit 1
          fi
          
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "primary_tag=${PRIMARY_TAG}" >> $GITHUB_OUTPUT
          echo "all_tags=${ALL_TAGS}" >> $GITHUB_OUTPUT
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          
          echo "PR Number: $PR_NUMBER"
          echo "Commit SHA: $COMMIT_SHA"
          echo "Primary Tag: $PRIMARY_TAG"

      - name: Download container artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: ${{ steps.pr-info.outputs.artifact_name }}
          path: /tmp/container
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Login to Quay
        if: env.HAS_QUAY_AUTH == 'true'
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_TOKEN }}

      - name: Load and push image
        if: env.HAS_QUAY_AUTH == 'true'
        id: push
        env:
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
          SHORT_SHA: ${{ steps.pr-info.outputs.short_sha }}
          ALL_TAGS: ${{ steps.pr-info.outputs.all_tags }}
        run: |
          echo "::group::Load container image from artifact"
          docker load -i /tmp/container/container-image.tar
          echo "::endgroup::"
          
          echo "::group::Tag and push images"
          LOADED_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -1)
          echo "Loaded image: $LOADED_IMAGE"
          
          # Tag and push each tag
          IFS=',' read -ra TAG_ARRAY <<< "$ALL_TAGS"
          PUSHED_TAGS=""
          for tag in "${TAG_ARRAY[@]}"; do
            FULL_TAG="${{ env.REGISTRY }}/${{ env.REGISTRY_IMAGE }}:${tag}"
            echo "Tagging and pushing: $FULL_TAG"
            docker tag "$LOADED_IMAGE" "$FULL_TAG"
            docker push "$FULL_TAG"
            if [[ -n "$PUSHED_TAGS" ]]; then
              PUSHED_TAGS="${PUSHED_TAGS},"
            fi
            PUSHED_TAGS="${PUSHED_TAGS}${tag}"
          done
          echo "::endgroup::"
          
          echo "pushed_tags=${PUSHED_TAGS}" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: env.HAS_QUAY_AUTH == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
          SHORT_SHA: ${{ steps.pr-info.outputs.short_sha }}
          PRIMARY_TAG: ${{ steps.pr-info.outputs.primary_tag }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);
            const shortSha = process.env.SHORT_SHA;
            const primaryTag = process.env.PRIMARY_TAG;
            const workflowRunId = process.env.WORKFLOW_RUN_ID;
            const registry = '${{ env.REGISTRY }}';
            const image = '${{ env.REGISTRY_IMAGE }}';
            
            const prTag = `pr-${prNumber}`;
            const prShaTag = `pr-${prNumber}-${shortSha}`;
            
            const body = `## Container Image Published
            
            | Tag | Image |
            |-----|-------|
            | \`${prTag}\` | \`${registry}/${image}:${prTag}\` |
            | \`${prShaTag}\` | \`${registry}/${image}:${prShaTag}\` |
            
            **Expires:** 2 weeks from now
            
            ### Pull Commands
            
            \`\`\`bash
            docker pull ${registry}/${image}:${prTag}
            # or with specific commit
            docker pull ${registry}/${image}:${prShaTag}
            \`\`\`
            
            ### Traceability
            
            - **Triggered by:** [PR Build #${workflowRunId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${workflowRunId})
            - **Commit:** \`${shortSha}\`
            `;
            
            // Find existing comment to update
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('## Container Image Published')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

      - name: Publish Summary
        if: env.HAS_QUAY_AUTH == 'true'
        env:
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
          SHORT_SHA: ${{ steps.pr-info.outputs.short_sha }}
          COMMIT_SHA: ${{ steps.pr-info.outputs.commit_sha }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          PR_TAG="pr-${PR_NUMBER}"
          PR_SHA_TAG="pr-${PR_NUMBER}-${SHORT_SHA}"
          
          echo "## PR Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| \`${{ env.REGISTRY }}/${{ env.REGISTRY_IMAGE }}:${PR_TAG}\` | ${PR_TAG} |" >> $GITHUB_STEP_SUMMARY
          echo "| \`${{ env.REGISTRY }}/${{ env.REGISTRY_IMAGE }}:${PR_SHA_TAG}\` | ${PR_SHA_TAG} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Expires:** 2 weeks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Traceability" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Pull Request:** [#${PR_NUMBER}](${{ github.server_url }}/${{ github.repository }}/pull/${PR_NUMBER})" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** [PR Build #${WORKFLOW_RUN_ID}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${WORKFLOW_RUN_ID})" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${SHORT_SHA}\`" >> $GITHUB_STEP_SUMMARY

      - name: No Auth Summary
        if: env.HAS_QUAY_AUTH != 'true'
        run: |
          echo "## PR Image Publish Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Registry credentials not configured. Image was not pushed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: #${{ steps.pr-info.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: \`${{ steps.pr-info.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY

  # Handle failed upstream workflow
  notify-failure:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    permissions: {}
    steps:
      - name: Failure Summary
        run: |
          echo "## PR Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The upstream PR Build workflow failed. No image was published." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed workflow:** [PR Build #${{ github.event.workflow_run.id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})" >> $GITHUB_STEP_SUMMARY
